name: Sync Dev with Main (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "CONFIRM" to proceed with synchronization'
        required: true
        default: ''

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'CONFIRM'
    
    permissions:
      contents: write  # Required to push to branches
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync dev with main
        run: |
          echo "Fetching latest changes..."
          git fetch origin
          
          echo "Checking out dev branch..."
          git checkout -B dev origin/main
          
          echo "Force pushing to remote dev..."
          git push --force origin dev
          
          echo "Synchronization complete!"
          
      - name: Verify synchronization
        run: |
          git fetch origin
          MAIN_SHA=$(git rev-parse origin/main)
          DEV_SHA=$(git rev-parse origin/dev)
          
          if [ "$MAIN_SHA" = "$DEV_SHA" ]; then
            echo "✅ Success! dev and main are now synchronized."
            echo "Both point to commit: $MAIN_SHA"
          else
            echo "❌ Error: Branches are not synchronized."
            echo "main: $MAIN_SHA"
            echo "dev: $DEV_SHA"
            exit 1
          fi
